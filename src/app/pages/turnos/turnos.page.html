<ion-header>
  <ion-toolbar>
    <ion-title>Mis Turnos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="mis-turnos-page" >
  <div class="content-container">

    <div class="toolbar-actions">
      <ion-button size="small" fill="solid" color="primary" (click)="exportTurnosPdf()" [disabled]="loading">
        Exportar PDF
      </ion-button>
    </div>

    <div class="pending-banner" *ngIf="pendingWritesCount > 0">
      <ion-icon name="cloud-offline-outline"></ion-icon>
      <span>{{ pendingWritesCount }} cambios pendientes de sincronizar</span>
    </div>

    <div class="calendar-card" *ngIf="!loading">
      <div class="calendar-header">
        <ion-button fill="clear" size="small" (click)="previousMonth()">
          <ion-icon name="chevron-back-outline"></ion-icon>
        </ion-button>
        <div class="calendar-title">{{ calendarMonthLabel }}</div>
        <ion-button fill="clear" size="small" (click)="nextMonth()">
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </div>

      <div class="calendar-grid">
        <div class="calendar-weekday" *ngFor="let w of weekdays">{{ w }}</div>
        <div class="calendar-day" *ngFor="let day of calendarDays" [class.outside]="!day.inMonth" [class.has-turnos]="day.count > 0" [class.selected]="selectedDateKey === formatDateKey(day.date)" (click)="selectDay(day)">
          <span class="day-number">{{ day.date.getDate() }}</span>
          <span class="day-count" *ngIf="day.count">{{ day.count }}</span>
        </div>
      </div>
    </div>

    <div class="day-detail" *ngIf="selectedDateKey">
      <div class="day-detail-header">
        <div class="day-detail-title">Turnos del {{ selectedDateKey }}</div>
        <ion-button size="small" fill="clear" (click)="clearSelectedDay()">Cerrar</ion-button>
      </div>
      <ion-list lines="none" class="day-detail-list" *ngIf="selectedDayTurnos.length > 0; else emptyDayTurnos">
        <ion-item *ngFor="let turno of selectedDayTurnos">
          <ion-label>
            <h3>{{ turno.startTime }} - {{ turno.endTime || turno.startTime }}</h3>
            <p>{{ turno.hours }}h 路 {{ turno.salary }} 路 {{ turno.tips }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
      <ng-template #emptyDayTurnos>
        <div class="day-detail-empty">No hay turnos para este d铆a.</div>
      </ng-template>
    </div>
    
    <!-- Spinner de carga -->
    <div class="loading-container" *ngIf="loading">
      <ion-spinner></ion-spinner>
    </div>

    <!-- Estado vac铆o -->
    <div class="empty-state" *ngIf="!loading && (!turnosPorSemana || turnosPorSemana.length === 0)">
      <div class="empty-icon"></div>
      <h3>No hay turnos</h3>
      <p>Toca el bot贸n + para crear tu primer turno</p>
    </div>

    <!-- Lista de turnos por semana -->
    <div *ngFor="let semana of turnosPorSemana" class="week-card">
      
      <h2>{{ semana.weekLabel }}</h2>
      <p class="week-summary">{{ semana.salarioTotal }} | {{ semana.horasTotales }}h</p>

      <ion-list lines="none">
        <ion-item *ngFor="let turno of semana.turnos" class="turno-item" button detail="false">
        

          <ion-label class="turno-info">
            <h3>
              {{ formatDate(turno.date) }} 
              <span *ngIf="turno.status==='completed'" class="top">Top</span>
              
            </h3>
            
            <div class="info-row hours">
                <span *ngIf="turno.customHourlyRate != null"> {{ turno.customHourlyRate }}/h</span>
              {{ turno.startTime }} - {{ turno.endTime }} ({{ turno.hours }}h)
            </div>
            
            <div class="info-row salary">
              Salario: {{ turno.salary }}
            </div>
            
            <div class="info-row tips">
              Propinas: {{ turno.tips }}
            </div>
            
            <div class="info-row notes" *ngIf="turno.notes">
              {{ turno.notes }}
            </div>
          </ion-label>
          
          <!-- Botones de acci贸n - siempre visibles en m贸vil -->
          <ion-buttons slot="end">
            <ion-button (click)="editarTurno(turno); $event.stopPropagation()" 
                       color="primary" 
                       size="small"
                       aria-label="Editar turno">
              <ion-icon name="create-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button (click)="eliminarTurno(turno.id); $event.stopPropagation()" 
                       color="danger" 
                       size="small"
                       aria-label="Eliminar turno">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
    </div>

   

  </div>

   <!-- Bot贸n FAB optimizado para m贸vil -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="abrirCrearTurno()" 
                     [disabled]="!userIdActual"
                     aria-label="Crear nuevo turno">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab>
</ion-content>
