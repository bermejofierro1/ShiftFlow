<ion-header>
  <ion-toolbar>
    <ion-title>Estadísticas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [class.loading]="loading">
  <div class="content-wrapper">
    <section class="hero-card">
      <div class="hero-text">
        <p class="eyebrow">Panel de rendimiento</p>
        <h1>Estadisticas de tus turnos</h1>
        <p class="subtext">Visualiza ingresos, horas y propinas en tiempo real.</p>
        <div class="chips">
          <span class="chip">Periodo: {{ periodo === 'mes' ? 'Mes en curso' : 'Semana en curso' }}</span>
          <span class="chip">Turnos: {{ turnos.length }}</span>
        </div>
      </div>
      <div class="hero-kpi">
        <p class="label">Total ingresos</p>
        <h2>{{ totalIngresos | currency:'EUR':'symbol':'1.2-2' }}</h2>
        <p class="muted">Mejor mes: {{ mejorMes || '—' }}</p>
      </div>
    </section>

    <div class="controls-row">
      <ion-segment [(ngModel)]="periodo" (ionChange)="cambiarPeriodo(periodo)">
        <ion-segment-button value="semana">Semana</ion-segment-button>
        <ion-segment-button value="mes">Mes</ion-segment-button>
        <ion-segment-button value="rango">Rango</ion-segment-button>
      </ion-segment>
      <div class="pill">Promedio general: {{ promedioTotal | currency:'EUR':'symbol':'1.2-2' }}</div>
    </div>

    <div class="filters-row">
      <div class="range-picker" *ngIf="periodo === 'rango'">
        <div class="range-field">
          <label>Inicio</label>
          <ion-input type="date" [(ngModel)]="rangeInicio" (ionChange)="onRangeChange()"></ion-input>
        </div>
        <div class="range-field">
          <label>Fin</label>
          <ion-input type="date" [(ngModel)]="rangeFin" (ionChange)="onRangeChange()"></ion-input>
        </div>
        <div class="range-helper">
          <ion-icon name="sparkles-outline"></ion-icon>
          <span>Filtra las metricas y graficos por fechas personalizadas.</span>
        </div>
      </div>

      <div class="location-filter">
        <label>Ubicacion</label>
        <ion-select interface="popover" [(ngModel)]="selectedLocation" (ionChange)="onLocationChange()">
          <ion-select-option value="all">Todas</ion-select-option>
          <ion-select-option *ngFor="let loc of locations" [value]="loc">{{ loc }}</ion-select-option>
        </ion-select>
      </div>
    </div>

    <div class="goal-card" *ngIf="hayDatos">
      <div class="goal-header">
        <div>
          <p class="eyebrow">Meta mensual (solo salario)</p>
          <h3>{{ monthlyGoal > 0 ? (monthlyGoal | currency:'EUR':'symbol':'1.0-0') : 'Define una meta' }}</h3>
          <p class="muted">Dias restantes: {{ diasRestantesMes }}</p>
        </div>
        <div class="goal-input">
          <ion-input type="number" placeholder="Meta €" [(ngModel)]="monthlyGoalInput"></ion-input>
          <ion-button size="small" (click)="guardarMeta()">Guardar</ion-button>
        </div>
      </div>
      <ion-progress-bar [value]="goalProgress / 100"></ion-progress-bar>
      <div class="goal-stats">
        <div>
          <small>Progreso</small>
          <strong>{{ goalProgress }}%</strong>
        </div>
        <div>
          <small>Falta segun proyeccion</small>
          <strong>{{ goalRemaining | currency:'EUR':'symbol':'1.2-2' }}</strong>
        </div>
        <div>
          <small>Turnos necesarios</small>
          <strong *ngIf="goalTurnosNecesarios > 0">{{ goalTurnosNecesarios }} (~{{ goalHorasNecesarias }} h)</strong>
          <strong *ngIf="goalTurnosNecesarios === 0">Meta cubierta</strong>
        </div>
      </div>
    </div>

    <div class="projection-card" *ngIf="hayDatos">
      <div>
        <p class="eyebrow">Proyeccion fin de mes</p>
        <h2>{{ projectedIngresosMes | currency:'EUR':'symbol':'1.2-2' }}</h2>
        <p class="muted">Propinas proyectadas: {{ projectedPropinasMes | currency:'EUR':'symbol':'1.2-2' }}</p>
        <div class="plan-to-best" *ngIf="ingresosMejorMes > 0">
          <div class="line">
            <span>Media por turno (mes):</span>
            <strong>{{ mediaIngresoTurnoMes | currency:'EUR':'symbol':'1.2-2' }} | {{ mediaHorasTurnoMes }} h</strong>
          </div>
          <div class="line">
            <span>Ingreso por hora (mes):</span>
            <strong>{{ mediaIngresoHoraMes | currency:'EUR':'symbol':'1.2-2' }}</strong>
          </div>
          <div class="line">
            <span>Para igualar mejor mes:</span>
            <strong *ngIf="turnosParaIgualar > 0">{{ turnosParaIgualar }} turnos (~{{ horasParaIgualar }} h)</strong>
            <strong *ngIf="turnosParaIgualar === 0">Ya igualado o superado</strong>
          </div>
        </div>
      </div>
      <div class="delta" [class.positive]="proyeccionVsMejorMes >= 0" [class.negative]="proyeccionVsMejorMes < 0">
        <ion-icon [name]="proyeccionVsMejorMes >= 0 ? 'trending-up-outline' : 'trending-down-outline'"></ion-icon>
        <div>
          <span>{{ proyeccionVsMejorMes | currency:'EUR':'symbol':'1.2-2' }}</span>
          <small>vs mejor mes</small>
        </div>
      </div>
    </div>

    <div class="reminder-card" *ngIf="recordatorioActivo">
      <div class="card-head">
        <div>
          <p class="eyebrow">Recordatorio accionable</p>
          <h3>Para alcanzar la meta de salario</h3>
        </div>
      </div>
      <p class="reminder-main">Te faltan ~{{ recordatorioHoras }} h ({{ recordatorioTurnos }} turnos) para llegar a la meta con tu ritmo actual.</p>
      <div class="reminder-grid">
        <div>
          <small>Sugerencia</small>
          <strong>{{ recordatorioTextoUbicacion }}</strong>
          <p>Refuerza en <span>{{ recordatorioTextoFranja }}</span> (~{{ recordatorioIngresoHoraRef | currency:'EUR':'symbol':'1.2-2' }}/h historico)</p>
        </div>
        <div>
          <small>Estrategia</small>
          <p>Distribuyelo esta semana: agrega horas/turnos extra en tu franja mas rentable.</p>
        </div>
      </div>
    </div>

    <div class="planner-card" *ngIf="weeklyPlanActivo">
      <div class="card-head">
        <div>
          <p class="eyebrow">Planificador semanal</p>
          <h3>Slots sugeridos hasta fin de semana</h3>
        </div>
        <div class="planner-pill">
          Falta ~{{ weeklyPlanHorasNecesarias }} h ({{ weeklyPlanTurnosNecesarios }} turnos)
        </div>
      </div>
      <div class="planner-grid">
        <div class="planner-item" *ngFor="let p of weeklyPlan">
          <div class="planner-date">{{ p.fecha }}</div>
          <div class="planner-body">
            <div class="planner-hours">{{ p.turnos }} turno(s) · {{ p.horas }} h</div>
            <div class="planner-meta">
              <span>{{ p.ubicacion }}</span>
              <span>{{ p.franja }}</span>
              <span>~{{ p.rate | currency:'EUR':'symbol':'1.0-0' }}/h</span>
            </div>
          </div>
        </div>
      </div>
      <p class="planner-hint">Reparte estas horas entre hoy y fin de semana en tu franja/ubicacion mas rentable.</p>
    </div>

    <ng-container *ngIf="hayDatos; else emptyStats">
      <div class="metrics-grid">
        <div class="metric-card primary">
          <div class="metric-label">Salario total</div>
          <div class="metric-value">{{ salarioTotal | currency:'EUR':'symbol':'1.2-2' }}</div>
          <span class="metric-hint">Periodo seleccionado</span>
        </div>
        <div class="metric-card accent">
          <div class="metric-label">Propinas totales</div>
          <div class="metric-value">{{ propinasTotal | currency:'EUR':'symbol':'1.2-2' }}</div>
          <span class="metric-hint">Incluye todas las propinas</span>
        </div>
        <div class="metric-card neutral">
          <div class="metric-label">Ganancia por turno</div>
          <div class="metric-value">{{ promedioPorTurno | currency:'EUR':'symbol':'1.2-2' }}</div>
          <span class="metric-hint">Media del periodo</span>
        </div>
        <div class="metric-card outline">
          <div class="metric-label">Horas totales</div>
          <div class="metric-value">{{ totalHoras }} h</div>
          <span class="metric-hint">Horas trabajadas</span>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="card-head">
            <div>
              <p class="eyebrow">Ingresos</p>
              <h3>Ingresos por mes</h3>
            </div>
            <span class="legend blue">EUR</span>
          </div>
          <canvas #ingresosCanvas></canvas>
        </div>

        <div class="chart-card">
          <div class="card-head">
            <div>
              <p class="eyebrow">Horas</p>
              <h3>Horas trabajadas (semana)</h3>
            </div>
            <span class="legend pink">Horas</span>
          </div>
          <canvas #horasCanvas></canvas>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-head">
          <div>
            <p class="eyebrow">Resumen</p>
            <h3>Vista rapida</h3>
          </div>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">Total ingresos</span>
            <span class="value">{{ totalIngresos | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Mejor mes</span>
            <span class="value">{{ mejorMes || '—' }} | {{ ingresosMejorMes | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Promedio por turno</span>
            <span class="value">{{ promedioTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #emptyStats>
      <div class="empty-state">
        <ion-icon name="analytics-outline" class="empty-icon"></ion-icon>
        <h3>Sin datos de estadisticas</h3>
        <p>Crea tus primeros turnos para ver ingresos, horas y propinas.</p>
      </div>
    </ng-template>
  </div>

  <ion-spinner *ngIf="loading" class="center-spinner"></ion-spinner>
</ion-content>
